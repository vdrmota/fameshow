<html>
<head>
   <meta charset="UTF-8">
   <title>Retention</title>
<style>
* {
	font-family : "Avenir"
}

.chartjs-wrapper {
	height: 770px
	width:385px;
	box-sizing:border-box;

}
.content {
	width:35%
}

@media only screen and (max-width: 600px) {
	.content {
		width:70%
	}
}

</style>
<script
			  src="https://code.jquery.com/jquery-3.3.1.min.js"
			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
			  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
<script>
var options = 
	{
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:true
                }
            }],
            xAxes: [{
                time: {
                    unit: 'day',
                    displayFormats: {
                        day: 'MMM D',
                    },
                    distribution: 'series'
                }
            }]
        },
        legend: {
            display: false
         },
         tooltips: {
            enabled: true
         }
    };

//var showDate = (!window.location.hash) ? "" : decodeURIComponent(window.location.hash.split('#')[1]);//2018-05-20 18:58:00

Array.range = (start, end) => Array.from({length: (end - start)}, (v, k) => k + start);


$.getJSON("http://44.fameshow.co/fame/db.php?q=SELECT ",function(data) {
	data.forEach(function(showDate){
		$("#schedule").append(`<a href = "./show.html?date=${showDate.showDate}">${showDate.showDate}</a><br>`)
	})
	//(new Date(showDate.showDate)).toLocaleDateString("en-US")
	//onClick="window.location.reload(false);"
});

//SELECT showDate, users.id, username, STR_TO_DATE(date,'%d:%m:%Y %H:%i:%s')accountCreation FROM `totalUsers` INNER JOIN `users` ON users.username = totalUsers.userOnline

let query = new URLSearchParams(window.location.search)

if (true){
	var showDate =  decodeURIComponent(query.get('date'))
$.when(
    $.get("http://44.fameshow.co/fame/db.php?q=SELECT showDate, users.id, username, STR_TO_DATE(date,'%d:%m:%Y %H:%i:%s')accountCreation FROM `totalUsers` INNER JOIN `users` ON users.username = totalUsers.userOnline ORDER BY accountCreation ASC"),
     $.get("http://44.fameshow.co/fame/db.php?q=SELECT showDate FROM `glance`  ORDER BY showDate ASC")
    )
    .done(function(usersPerShow, shows){
        //do something
        console.log(usersPerShow)

        usersPerShow        = JSON.parse(usersPerShow[0])
        shows               = JSON.parse(shows[0])

        console.log(usersPerShow,shows)
        var ctx = document.getElementById("ret");

        var datasets = [];
        var userData = []
        for (var i = 0; i < usersPerShow.length; i++) {
        	var curr = usersPerShow[i];
        	var prev = {}
        	if (i > 0) {
        		prev = usersPerShow[i - 1]
        	} else {
        		prev = curr;
        	}
        	
        	console.log(prev.username, curr.username, userData)
        	if (curr.username !== prev.username || i == usersPerShow.length - 1) {
        		var dataset = {}
        		dataset.label = "hi";//prev.username;
        		dataset.backgroundColor = ['rgba(255, 99, 132, 0.2)'];
        		dataset.borderColor = ['rgba(255,99,132,1)']
        		dataset.borderWidth = 1;
        		dataset.lineTension = 0;
        		dataset.data = userData
        		dataset.showLine = false;

        		datasets.push(dataset);
        		userData = [];//[{x : new Date(curr.accountCreation), y : curr.id}];

        	} else {
        		userData.push({x : new Date(curr.showDate), y : curr.id})
        	}
        }

        //datasets = datasets.slice(1, datasets.length);

		var myLineChart = new Chart(ctx, {
		    type: 'scatter',
	    	data: {
		        //labels: shows.map(x => new Date(x.showDate)),//Array.range(0, shows.length +datasets.length),
		        datasets: datasets
		    },
	    	options: options
		});
    })
    .fail(function(){
    	console.log('fail')
        //handle errors
    });



    }



</script>

</head>
<body>
	<center>
		<div class = "content">
		<h5>Retention</h5>
		<canvas id="ret" width="400" height="400"></canvas>
		</div>
	</center>
</body>
</html>